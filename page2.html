<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston College Room Occupancy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        h1 {
            margin-bottom: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            grid-auto-flow: column;
            align-content: end; /* Aligns the grid to the bottom */
        }

        .room {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #333;
            background-color: gold; /* Unoccupied color */
            color: black;
            cursor: pointer;
            position: relative;
            font-size: 20px;
            height: 100px; /* Fixed height for room representation */
        }

        .room.occupied {
            background-color: maroon; /* Occupied color */
        }

        .selector-container {
            margin: 20px;
        }

        .time-selector,
        .day-selector {
            margin-bottom: 10px;
        }

        /* Modal styles */
        #modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        #modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Center the buttons */
        #occupy-button,
        #studying-button {
            display: inline-block;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Boston College Room Occupancy</h1>
    <div class="selector-container">
        <div class="time-selector">
            <label for="time">Select Time: </label>
            <input type="time" id="time" value="12:00">
        </div>
        <div class="day-selector">
            <label for="day">Select Day: </label>
            <select id="day">
                <option value="Su">Sunday</option>
                <option value="M">Monday</option>
                <option value="Tu">Tuesday</option>
                <option value="W">Wednesday</option>
                <option value="Th">Thursday</option>
                <option value="F">Friday</option>
                <option value="Sa" selected>Saturday</option>
            </select>
        </div>
    </div>
    <div class="grid-container" id="room-grid">
        <!-- Rooms will be populated here -->
    </div>

    <!-- Modal for class info -->
    <div id="modal">
        <div id="modal-content">
            <span class="close" id="back-button">&times;</span>
            <p id="modal-message"><span id="occupant-name"></span></p>
            <button id="occupy-button">Room is Already Occupied</button>
            <button id="studying-button">I am Studying Here</button>
        </div>
    </div>

    <script>
        let classSchedules = []; // This will hold the JSON data
        let currentRoom = null; // Current room being interacted with

        // Function to fetch the JSON data
        async function fetchRoomData() {
            try {
                const response = await fetch('/room_schedule.json'); // Adjust the path as necessary
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                classSchedules = await response.json(); // Parse JSON data
                populateRooms(document.getElementById('time').value, document.getElementById('day').value); // Populate rooms after fetching
            } catch (error) {
                console.error('Error fetching room data:', error);
            }
        }

        // Function to populate rooms
        function populateRooms(selectedTime, selectedDay) {
            const roomGrid = document.getElementById('room-grid');
            roomGrid.innerHTML = ''; // Clear previous room elements

            // Get the current time's hours and minutes
            const [selectedHour, selectedMinute] = selectedTime.split(':').map(Number);
            const currentTime = selectedHour * 60 + selectedMinute; // Convert to minutes for easier comparison

            // Add rooms to the grid in tower shape
            const uniqueRooms = {};

            classSchedules.forEach(schedule => {
                console.log("Processing schedule:", schedule);
                const roomNumber = schedule.room;
                if (!uniqueRooms[roomNumber]) {
                    uniqueRooms[roomNumber] = { room: roomNumber, occupied: false, course_title: '' };
                }

                // Check if the room is occupied at the selected time and day
                if (schedule.days.includes(selectedDay)) {
                    for (const period of schedule.schedule) {
                        const [startHour, startMinute] = convertTimeToMinutes(period.start);
                        const [endHour, endMinute] = convertTimeToMinutes(period.end);

                        // Check if the current time falls within the class schedule
                        if (currentTime >= startHour * 60 + startMinute && currentTime < endHour * 60 + endMinute) {
                            uniqueRooms[roomNumber].occupied = true; // Mark room as occupied
                            uniqueRooms[roomNumber].course_title = schedule.course_title; // Assign the course title
                            console.log(`Room: ${roomNumber}, Course Title: ${uniqueRooms[roomNumber].course_title}`); // Debugging
                            break;
                        }
                    }
                }
            });

            // Unique room numbers organized by floor
            const roomOrder = ['102', '103', '104', '107', '123', '125', '204', '205', '214', '215', '229', '230', '302', '311']; // Example order
            roomOrder.forEach(roomNumber => {
                if (uniqueRooms[roomNumber]) {
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'room' + (uniqueRooms[roomNumber].occupied ? ' occupied' : '');
                    roomDiv.dataset.room = roomNumber;
                    roomDiv.textContent = `Room ${roomNumber}`;

                    // Add click event listener for room interaction
                    roomDiv.addEventListener('click', () => handleRoomClick(uniqueRooms[roomNumber]));
                    
                    roomGrid.appendChild(roomDiv);
                }
            });
        }

        // Convert time string to minutes
        function convertTimeToMinutes(time) {
            const [timeString, modifier] = time.split(' ');
            let [hours, minutes] = timeString.split(':').map(Number);

            if (modifier === 'PM' && hours < 12) hours += 12;
            if (modifier === 'AM' && hours === 12) hours = 0;

            return [hours, minutes];
        }
        function handleRoomClick(room) {
            currentRoom = room; // Set the current room
            const modal = document.getElementById('modal');
            const occupantNameSpan = document.getElementById('occupant-name');

            // Show appropriate message based on the room state
            if (room.occupied && room.course_title) {
                occupantNameSpan.textContent = `Occupied by: ${room.course_title}`; // Display course title if occupied
                document.getElementById('occupy-button').style.display = 'none'; // Hide occupy button
                document.getElementById('studying-button').style.display = 'none'; // Hide studying button
            } else {
                occupantNameSpan.textContent = "Available"; // Show available message
                document.getElementById('occupy-button').style.display = 'inline-block'; // Show occupy button
                document.getElementById('studying-button').style.display = 'inline-block'; // Show studying button
            }

            modal.style.display = 'block'; // Show modal
        }


        // Function to handle occupying the room
            function handleOccupyRoom() {
            if (currentRoom) {
                currentRoom.occupied = true;
                const roomDiv = document.querySelector(`[data-room="${currentRoom.room}"]`);
                roomDiv.classList.add('occupied');
                roomDiv.textContent = `Room ${currentRoom.room} (Occupied)`;
                document.getElementById('modal').style.display = 'none';
                populateRooms(document.getElementById('time').value, document.getElementById('day').value);
            }
        }

        function handleStudying() {
            if (currentRoom) {
                const occupantName = prompt("Please enter your name:");
                if (occupantName) {
                    currentRoom.occupied = true;
                    currentRoom.course_title = `${occupantName} - Studying`;
                    const roomDiv = document.querySelector(`[data-room="${currentRoom.room}"]`);
                    roomDiv.classList.add('occupied');
                    roomDiv.textContent = `Room ${currentRoom.room})`;
                    document.getElementById('modal').style.display = 'none';
                    
                    // Update the room data in the uniqueRooms array
                    const roomIndex = uniqueRooms.findIndex(room => room.room === currentRoom.room);
                    if (roomIndex !== -1) {
                        uniqueRooms[roomIndex] = currentRoom;
                    }
                    
                    // Re-populate the rooms to reflect the changes
                    populateRooms(document.getElementById('time').value, document.getElementById('day').value);
                }
            }
        }

        // Close modal when clicking the close button
        document.getElementById('back-button').onclick = function() {
            document.getElementById('modal').style.display = 'none';
        }

        // Event listener for the time selector
        document.getElementById('time').addEventListener('change', (event) => {
            populateRooms(event.target.value, document.getElementById('day').value);
        });

        // Event listener for the day selector
        document.getElementById('day').addEventListener('change', (event) => {
            populateRooms(document.getElementById('time').value, event.target.value);
        });

        // Event listeners for modal buttons
        document.getElementById('occupy-button').onclick = handleOccupyRoom;
        document.getElementById('studying-button').onclick = handleStudying;

        // Fetch room data when the page loads
        window.onload = fetchRoomData;
    </script>
</body>
</html>